define(["jquery","util","cookie"],function(o,s){var a="",n="",c="",l="",p="",r="",d="",u="",f=0,h="0fe2f3cdb2064a3375690e4e3f55b390",v=timestamp=Date.parse(new Date)/1e3;function m(e,i,t){0==t&&(v=timestamp=Date.parse(new Date)/1e3,f<v+30&&o.ajax({async:!1,type:"GET",url:"/user/enterprise/aliyun_oss_signature",headers:{token:h},contentType:"application/json;charset=utf-8",data:{noCache:(new Date).getTime(),file_type:l},success:function(e){if(0===e.code){var i=e.data;return c=i.host,d=i.policy,a=i.accessKeyId,u=i.signature,f=parseInt(i.expire),p=i.dir,!0}}}),t=!1),r=p,""!=i&&(n=function(e){pos=e.lastIndexOf("."),n="",-1!=pos&&(n=e.substring(pos));return n}(i),r+=Date.now()+"_"+l+n),new_multipart_params={key:r,policy:d,expire:f,OSSAccessKeyId:a,success_action_status:"200",signature:u},e.setOption({url:c,multipart_params:new_multipart_params}),e.start()}({uploadEles:[],isSend:!1,fileList:{},getPriseFiles:function(){var i=this;o.ajax({type:"GET",url:"/user/enterprise/enterprise_files",headers:{token:h},contentType:"application/json;charset=utf-8",data:{noCache:(new Date).getTime()},success:function(e){0===e.code&&(i.fileList=e.data,i.showImgFile())}})},showImgFile:function(){var s=this.fileList;o(".upload-box").each(function(e){var i=o(this).attr("data-type");for(var t in s)if(i===t&&s[i].file_path){var a='<div class="has-pic"><i class="icon-delete"></i><p class="pic"><img data-src='+s[i].file_path+" src="+s[i].file_url+"></p></div>";o(this).find(".add").attr("data-flag",1).fadeOut(200),o(this).append(a).fadeIn(200)}})},fileCheck:function(e,i){var t=!0;return i||((new s.Modal).init({type:0,canClose:!0,title:"提示",content:'<p class="appo-box"><i class="icon-warning"></i> 请上传'+e+"</p>"}),t=!1),t},fileInit:function(){var s=this,e={},n=!0;return o(".upload-box").each(function(e){var i=o(this).attr("file-type"),t=o(this).attr("check"),a=o(this).find("img").attr("data-src");if(t){if(!s.fileCheck(t,a))return n=!1;s.uploadEles.push({file_type:i,file_path:a})}else s.uploadEles.push({file_type:i,file_path:a})}),e.files=s.uploadEles,!!n&&e},init:function(){var i=this;this.getPriseFiles(),o(".view").on("click",function(){var e=o(this).attr("data-src");if(console.log(e),e){var i='<div class="upload-mask"><div class="upload-view"><p class="img"><img src="'+e+'"></p></div></div>';o("body").append(i)}}),o("body").on("click",".icon-delete",function(){o(this).parent(".has-pic").siblings(".add");o(this).parent(".has-pic").fadeOut(200).siblings(".add").fadeIn(400),o(this).parent(".has-pic").remove()}),o("body").on("click",".pic",function(){var e=o(this).find("img").attr("src");if(e){var i='<div class="upload-mask"><div class="upload-view"><p class="img"><img src="'+e+'"></p></div></div>';o("body").append(i)}}),o("body").on("click",".upload-mask",function(){o(this).remove()}),o("#gonext").click(function(){var e=i.fileInit();e&&!this.isSend&&o.ajax({type:"POST",url:"/user/open_fund",headers:{token:h},contentType:"application/json;charset=utf-8",data:JSON.stringify(e),beforeSend:function(){i.isSend=!0},success:function(e){0===e.code?window.location.href="/user/register-finish":(new s.Modal).init({type:0,canClose:!0,title:"提示",content:'<p class="appo-box"><i class="icon-warning"></i>'+e.msg+"</p>"})},complete:function(){i.isSend=!1}})})}}).init();for(var e=o(".add"),i=0;i<e.length;i++)!function(a){var t=new plupload.Uploader({runtimes:"html5,flash,silverlight,html4",browse_button:a,container:a.parentNode,url:"http://oss.aliyuncs.com",init:{FilesAdded:function(e,i){2097152<=i[0].size&&((new s.Modal).init({type:0,canClose:!0,title:"提示",content:'<p class="appo-box"><i class="icon-warning"></i>图片大小不超过2M</p>'}),e.removeFile(i[0])),l=o(a.parentNode).attr("file-type"),m(t,"",!1)},BeforeUpload:function(e,i){m(e,i.name,!0)},FileUploaded:function(e,i,t){200==t.status&&o.ajax({type:"POST",url:"/user/enterprise/oss_presigned_url",headers:{token:h},data:{file_path:r},success:function(e){if(0===e.code){var i='<div class="has-pic"><i class="icon-delete"></i><p class="pic"><img data-src='+r+" src="+e.data+"></p></div>";o(a).stop().fadeOut(200).parent(".upload-box").append(i).fadeIn(200)}else(new s.Modal).init({type:0,canClose:!0,title:"提示",content:'<p class="appo-box"><i class="icon-warning"></i>'+e.msg+"</p>"})}})},Error:function(e,i){(new s.Modal).init({type:0,canClose:!0,title:"错误提示",content:'<div class="appo-box"><i class="error"></i>'+i.file+i.message+"</div>"})}}});t.init()}(e[i])});