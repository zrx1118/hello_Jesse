define(["jquery","util","flatpickr"],function(d,p){({isSend:!1,isRmb:!1,isLegalRmb:!1,isAgreen:!1,form1:null,enterprise_id_type:null,trade:null,cor_property:null,bank_id:null,bankId:"",province_code:null,provinceCode:"",city_code:null,cityCode:"",branch_no:null,branchCode:"",certifyDate:"",legalCertifyDate:"",enterpriseTypeList:[{text:"营业执照",value:13},{text:"组织机构代码",value:0}],tradeList:[{text:"金融机构",value:0},{text:"教育",value:1},{text:"保险机构",value:4},{text:"一般机构",value:3},{text:"其他",value:2}],corList:[{text:"国企",value:0},{text:"民营",value:1},{text:"合资",value:2},{text:"其他",value:3}],bankList:[],provinceList:[],cityList:[],branchList:[],$enterprise_valid_time:document.getElementById("enterprise_valid_time"),$instrepr_valid_time:document.getElementById("instrepr_valid_time"),$certifyRmb:d("#certifyRmb"),$legalCertifyRmb:d("#legalCertifyRmb"),$agreenPro:d("#agreenPro"),gonext:function(){var e=this.form1.formCheck();!this.isSend&&e&&(this.isRmb&&(e.enterprise_valid_time="2999-12-31"),this.isLegalRmb&&(e.instrepr_valid_time="2999-12-31"),this.isAgreen?(e.reg_capital=parseFloat(e.reg_capital).toFixed(2),e.bank_id=parseInt(e.bank_id),e.cor_property=parseInt(e.cor_property),e.trade=parseInt(e.trade),d.ajax({type:"POST",url:"/user/enterprise/enterprise_info/do",contentType:"application/json;charset=utf-8",data:JSON.stringify(e),beforeSend:function(){this.isSend=!0},success:function(e){0===e.code?window.location.href="/user/register-upload":(new p.Modal).init({type:0,canClose:!0,title:"提示",content:'<p class="appo-box"><i class="icon-warning"></i>'+e.msg+"</p>"})},complete:function(){this.isSend=!1},error:function(){window.location.href="/500"}})):d("#vf-tip").html("协议未勾选").fadeIn(200))},certifyRmb:function(){this.isRmb=!this.isRmb,this.isRmb?(this.$certifyRmb.addClass("check"),d("#enterprise_valid_time").attr("disabled",!0)):(this.$certifyRmb.removeClass("check"),d("#enterprise_valid_time").attr("disabled",!1))},certifyLegalRmb:function(){this.isLegalRmb=!this.isLegalRmb,this.isLegalRmb?(this.$legalCertifyRmb.addClass("check"),d("#instrepr_valid_time").attr("disabled",!0)):(this.$legalCertifyRmb.removeClass("check"),d("#instrepr_valid_time").attr("disabled",!1))},agreenPro:function(){this.isAgreen=!this.isAgreen,this.isAgreen?(this.$agreenPro.addClass("check"),d("#vf-tip").html("").fadeOut(200)):this.$agreenPro.removeClass("check")},getBankList:function(t){d.ajax({async:!0,type:"POST",url:"/user/enterprise/available_bank/list",contentType:"application/json;charset=utf-8",data:"",success:function(e){if(0===e.code){var n=[];e.data.forEach(function(e,t){var i={};i.text=e.bank_name,i.value=e.bank_id,n.push(i)}),t&&t(n)}}})},getProvince:function(t){d.ajax({async:!0,type:"GET",url:"/user/enterprise/province_list",contentType:"application/json;charset=utf-8",data:{noCache:(new Date).getTime()},success:function(e){if(0===e.code){var n=[];e.data.forEach(function(e,t){var i={};i.text=e.province_name,i.value=e.province_code,n.push(i)}),t&&t(n)}}})},getCity:function(e,i){var a=this;d.ajax({async:!0,type:"POST",url:"/user/enterprise/city_list",contentType:"application/json;charset=utf-8",data:JSON.stringify({province_code:e}),success:function(e){if(0===e.code&&e.data.hasOwnProperty("province_code")){var n=[];e.data.city_list.forEach(function(e,t){var i={};i.text=e.city_name,i.value=e.city_code,n.push(i)});var t=a.getIndex(n,i);a.city_code.setOption(n,t),a.cityCode=i,a.getBranchNo()}}})},getBranchNo:function(){var i=this;this.bankId&&this.provinceCode&&this.cityCode&&d.ajax({async:!0,url:"/user/enterprise/branch_list",type:"POST",contentType:"application/json;charset=utf-8",data:JSON.stringify({bank_id:this.bankId,province_code:this.provinceCode,city_code:this.cityCode}),success:function(e){if(0===e.code){var n=[];e.data.length&&e.data.forEach(function(e,t){var i={};i.text=e.branch_name,i.value=e.branch_no,n.push(i)});var t=i.getIndex(n,i.branchCode);i.branch_no.setOption(n,t)}}})},getIndex:function(e,t){for(var i=0,n=e.length;i<n;i++)if(e[i].value===t)return i},getOriginData:function(){var l=this;d.ajax({async:!0,type:"GET",url:"/user/enterprise/enterprise_info",contentType:"application/json;charset=utf-8",data:{noCache:(new Date).getTime()},success:function(e){if(0===e.code){var t=e.data,n={};for(var i in t)if(t[i]instanceof Object)for(var a in t[i])n[a]=t[i][a];else n[i]=t[i];l.branchCode=n.branch_no;for(var r=d(".select"),c=(i=0,r.length);i<c;i++)switch(d(r[i]).attr("select")){case"enterprise_id_type":l.enterprise_id_type=(new p.Select).init({oWrap:d("#enterprise_id_type"),defaultText:"请选择证件类型",data:l.enterpriseTypeList,onInit:function(e){},onChange:function(e){}});var o=l.getIndex(l.enterpriseTypeList,n.enterprise_id_type);l.enterprise_id_type.setOption(l.enterpriseTypeList,o);break;case"trade":l.trade=(new p.Select).init({oWrap:d("#trade"),defaultText:"请选择行业",data:l.tradeList,onInit:function(e){},onChange:function(e){}});o=l.getIndex(l.tradeList,n.trade);l.trade.setOption(l.tradeList,o);break;case"cor_property":l.cor_property=(new p.Select).init({oWrap:d("#cor_property"),defaultText:"请选择企业类型",data:l.corList,onInit:function(e){},onChange:function(e){}});o=l.getIndex(l.corList,n.cor_property);l.cor_property.setOption(l.corList,o);break;case"bank_id":l.bank_id=(new p.Select).init({oWrap:d("#bank_id"),defaultText:"请选择开户银行",data:[],onInit:function(e){},onChange:function(e){l.bankId=e.value,l.getBranchNo()},initCallback:function(i){l.getBankList(function(e){l.bankId=n.bank_id,l.getBranchNo();var t=l.getIndex(e,n.bank_id);i.setOption(e,t)})}});break;case"province_code":l.province_code=(new p.Select).init({oWrap:d("#province_code"),defaultText:"请选择省份",data:[],onInit:function(){},onChange:function(e){l.provinceCode=e.value,l.getCity(e.value,n.city_code)},initCallback:function(i){l.getProvince(function(e){l.provinceCode=n.province_code;var t=l.getIndex(e,n.province_code);i.setOption(e,t,l.getCity(i.value,n.city_code))})}});break;case"city_code":l.city_code=(new p.Select).init({oWrap:d("#city_code"),defaultText:"请选择城市",data:[],onChange:function(e){l.cityCode=e.value,l.getBranchNo()}});break;case"branch_no":l.branch_no=(new p.Select).init({oWrap:d("#branch_no"),search:!0,defaultText:"请选择支行",data:[]})}for(var s in n)d("#"+s).attr("select")||(d("#"+s).val(n[s]),d("#"+s).attr("validDate")&&new Date(n[s])>=new Date("2999-12-30")&&d("#"+s).siblings(".long").find(".remember").click())}else(new p.Modal).init({type:0,canClose:!0,title:"提示",content:'<p class="appo-box"><i class="icon-warning"></i>'+e.msg+"</p>"})}})},init:function(){var n=this;this.form1=(new p.Validate).init({form:d("#formPerfect")}),this.getOriginData(),!this.isRmb&&this.$enterprise_valid_time.flatpickr({onChange:function(e,t,i){n.form1._valid(3,!0,!1)}}),!this.isLegalRmb&&this.$instrepr_valid_time.flatpickr({onChange:function(e,t,i){n.form1._valid(18,!0,!1)}}),this.$certifyRmb.on("click",function(){n.certifyRmb()}),this.$legalCertifyRmb.on("click",function(){n.certifyLegalRmb()}),this.$agreenPro.on("click",function(){n.agreenPro()}),d("#gonext").on("click",function(){n.gonext()})}}).init()});